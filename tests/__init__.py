"""Tests for IPP."""
import asyncio
import socket

from aiohttp import web
from aiohttp.test_utils import RawTestServer

DEFAULT_PRINTER_URI = "ipp://printer.example.com:631/ipp/print"

RESPONSE_GET_PRINTER_ATTRIBUTES_FULL = b'\x02\x00\x00\x00\x00\x00w\x1b\x01G\x00\x12attributes-charset\x00\x05utf-8H\x00\x1battributes-natural-language\x00\x02en\x04!\x00\x0ecopies-default\x00\x04\x00\x00\x00\x013\x00\x10copies-supported\x00\x08\x00\x00\x00\x01\x00\x00\x00c#\x00\x12finishings-default\x00\x04\x00\x00\x00\x03#\x00\x14finishings-supported\x00\x04\x00\x00\x00\x03D\x00\rsides-default\x00\tone-sidedD\x00\x0fsides-supported\x00\tone-sidedD\x00\x00\x00\x14two-sided-short-edgeD\x00\x00\x00\x13two-sided-long-edge#\x00\x1dorientation-requested-default\x00\x04\x00\x00\x00\x03#\x00\x1forientation-requested-supported\x00\x04\x00\x00\x00\x03D\x00\rmedia-default\x00\x12na_letter_8.5x11inD\x00\x0fmedia-supported\x00\x12na_letter_8.5x11inD\x00\x00\x00\x12na_index-4x6_4x6inD\x00\x00\x00\x0cna_5x7_5x7inD\x00\x00\x00\x15na_govt-letter_8x10inD\x00\x00\x00\x19om_hivision_101.6x180.6mmD\x00\x00\x00\x10iso_a4_210x297mmD\x00\x00\x00\x10iso_a6_105x148mmD\x00\x00\x00\x11na_legal_8.5x14inD\x00\x00\x00\x12oe_photo-l_3.5x5inD\x00\x00\x00\x14na_invoice_5.5x8.5inD\x00\x00\x00\x18na_number-10_4.125x9.5inD\x00\x00\x00\x14na_foolscap_8.5x13inD\x00\x00\x00\x12disc_12cm_18x120mmD\x00\x00\x00\x13custom_min_89x127mmD\x00\x00\x00\x19custom_max_215.9x1117.6mm2\x00\x1aprinter-resolution-default\x00\t\x00\x00\x01h\x00\x00\x01h\x032\x00\x1cprinter-resolution-supported\x00\t\x00\x00\x01h\x00\x00\x01h\x032\x00\x00\x00\t\x00\x00\x02\xd0\x00\x00\x02\xd0\x032\x00\x00\x00\t\x00\x00\x16\x80\x00\x00\x05\xa0\x03#\x00\x15print-quality-default\x00\x04\x00\x00\x00\x04#\x00\x17print-quality-supported\x00\x04\x00\x00\x00\x04#\x00\x00\x00\x04\x00\x00\x00\x05D\x00\x12output-bin-default\x00\x07face-upD\x00\x14output-bin-supported\x00\x07face-upD\x00\x13media-col-supported\x00\nmedia-sizeD\x00\x00\x00\x10media-top-marginD\x00\x00\x00\x11media-left-marginD\x00\x00\x00\x12media-right-marginD\x00\x00\x00\x13media-bottom-marginD\x00\x00\x00\nmedia-typeD\x00\x00\x00\x0cmedia-source4\x00\x11media-col-default\x00\x00J\x00\x00\x00\nmedia-size4\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00TVJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00m$7\x00\x00\x00\x00J\x00\x00\x00\x10media-top-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x11media-left-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x12media-right-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x13media-bottom-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\nmedia-typeD\x00\x00\x00\nstationeryJ\x00\x00\x00\x0cmedia-sourceD\x00\x00\x00\x04main7\x00\x00\x00\x00D\x00\x18print-color-mode-default\x00\x04autoD\x00\x1aprint-color-mode-supported\x00\x05colorD\x00\x00\x00\nmonochromeD\x00\x00\x00\x0fauto-monochromeD\x00\x00\x00\x12process-monochromeD\x00\x00\x00\x04autoD\x00\x1eprint-content-optimize-default\x00\x04autoD\x00 print-content-optimize-supported\x00\x04autoD\x00\x15print-scaling-default\x00\x04autoD\x00\x17print-scaling-supported\x00\x04autoD\x00\x00\x00\x08auto-fitD\x00\x00\x00\x04fillD\x00\x00\x00\x03fitD\x00\x00\x00\x04noneD\x00\x0bmedia-ready\x00\x12na_letter_8.5x11inD\x00\x00\x00\x12na_index-4x6_4x6inD\x00\x00\x00\x12disc_12cm_18x120mm4\x00\x0fmedia-col-ready\x00\x00J\x00\x00\x00\nmedia-size4\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00TVJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00m$7\x00\x00\x00\x00J\x00\x00\x00\x10media-top-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x11media-left-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x12media-right-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x13media-bottom-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\nmedia-typeD\x00\x00\x00\nstationeryJ\x00\x00\x00\x0cmedia-sourceD\x00\x00\x00\x04main7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\nmedia-size4\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00\'\xb0J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00;\x887\x00\x00\x00\x00J\x00\x00\x00\x10media-top-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x11media-left-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x12media-right-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\x13media-bottom-margin!\x00\x00\x00\x04\x00\x00\x01,J\x00\x00\x00\nmedia-typeD\x00\x00\x00\x0cphotographicJ\x00\x00\x00\x0cmedia-sourceD\x00\x00\x00\x05photo7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\nmedia-size4\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00\'\xb0J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00;\x887\x00\x00\x00\x00J\x00\x00\x00\x10media-top-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\x11media-left-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\x12media-right-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\x13media-bottom-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\nmedia-typeD\x00\x00\x00\x0cphotographicJ\x00\x00\x00\x0cmedia-sourceD\x00\x00\x00\x05photo7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\nmedia-size4\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00.\xe0J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00.\xe07\x00\x00\x00\x00J\x00\x00\x00\x10media-top-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\x11media-left-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\x12media-right-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\x13media-bottom-margin!\x00\x00\x00\x04\x00\x00\x00\x00J\x00\x00\x00\nmedia-typeD\x00\x00\x00\x04discJ\x00\x00\x00\x0cmedia-sourceD\x00\x00\x00\x04disc7\x00\x00\x00\x004\x00\x14media-size-supported\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00TVJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00m$7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00\'\xb0J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00;\x887\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x001\x9cJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00Et7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00O`J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00c87\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00\'\xb0J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00F\x8c7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00R\x08J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00t\x047\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00)\x04J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x009\xd07\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00TVJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00\x8a\xe87\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00"\xbaJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x001\x9c7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x006\x92J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00TV7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00(\xedJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00^B7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00TVJ\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00\x80\xfc7\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension!\x00\x00\x00\x04\x00\x00.\xe0J\x00\x00\x00\x0by-dimension!\x00\x00\x00\x04\x00\x00.\xe07\x00\x00\x00\x004\x00\x00\x00\x00J\x00\x00\x00\x0bx-dimension3\x00\x00\x00\x08\x00\x00"\xc4\x00\x00TVJ\x00\x00\x00\x0by-dimension3\x00\x00\x00\x08\x00\x001\x9c\x00\x01\xb4\x907\x00\x00\x00\x00D\x00\x14media-type-supported\x00\nstationeryD\x00\x00\x00\x17photographic-high-glossD\x00\x00\x00\x0cphotographicD\x00\x00\x00\x17photographic-semi-glossD\x00\x00\x00\x13photographic-glossyD\x00\x00\x00\x12photographic-matteD\x00\x00\x00\x10com.epson-lusterD\x00\x00\x00\x08envelopeD\x00\x00\x00\x11stationery-coatedD\x00\x00\x00\x04discD\x00\x16media-source-supported\x00\x04autoD\x00\x00\x00\x04mainD\x00\x00\x00\x05photoD\x00\x00\x00\x04disc!\x00\x1amedia-top-margin-supported\x00\x04\x00\x00\x00\x00!\x00\x00\x00\x04\x00\x00\x01,!\x00\x1bmedia-left-margin-supported\x00\x04\x00\x00\x00\x00!\x00\x00\x00\x04\x00\x00\x01,!\x00\x1cmedia-right-margin-supported\x00\x04\x00\x00\x00\x00!\x00\x00\x00\x04\x00\x00\x01,!\x00\x1dmedia-bottom-margin-supported\x00\x04\x00\x00\x00\x00!\x00\x00\x00\x04\x00\x00\x01,G\x00\x12charset-configured\x00\x05utf-8G\x00\x11charset-supported\x00\x05utf-8"\x00\x0fcolor-supported\x00\x01\x01D\x00\x15compression-supported\x00\x04noneD\x00\x00\x00\x04gzipI\x00\x17document-format-default\x00\x18application/octet-streamI\x00\x19document-format-supported\x00\x18application/octet-streamI\x00\x00\x00\x10image/pwg-rasterI\x00\x00\x00\timage/urfI\x00\x00\x00\nimage/jpegH\x00$generated-natural-language-supported\x00\x02enD\x00\x16ipp-versions-supported\x00\x031.0D\x00\x00\x00\x031.1D\x00\x00\x00\x032.0H\x00\x1bnatural-language-configured\x00\x02en#\x00\x14operations-supported\x00\x04\x00\x00\x00\x02#\x00\x00\x00\x04\x00\x00\x00\x04#\x00\x00\x00\x04\x00\x00\x00\x05#\x00\x00\x00\x04\x00\x00\x00\x06#\x00\x00\x00\x04\x00\x00\x00\x08#\x00\x00\x00\x04\x00\x00\x00\t#\x00\x00\x00\x04\x00\x00\x00\n#\x00\x00\x00\x04\x00\x00\x00\x0b#\x00\x00\x00\x04\x00\x00\x00;#\x00\x00\x00\x04\x00\x00\x00<!\x00\x10pages-per-minute\x00\x04\x00\x00\x00\t!\x00\x16pages-per-minute-color\x00\x04\x00\x00\x00\tD\x00\x16pdl-override-supported\x00\tattempted0\x00\rprinter-alert\x00\ncode=otherA\x00\x19printer-alert-description\x00\x04idleA\x00\x11printer-device-id\x01\x18MFG:EPSON;CMD:ESCPL2,BDC,D4,D4PX,ESCPR7,END4,GENEP,URF;MDL:XP-6000 Series;CLS:PRINTER;DES:EPSON XP-6000 Series;CID:EpsonRGB;FID:FXN,DPA,WFA,ETN,AFN,DAN,WRA;RID:20;DDS:022500;ELG:1000;SN:583434593035343012;URF:CP1,PQ4-5,OB9,OFU0,RS360,SRGB24,W8,DM3,IS1-7-6,V1.4,MT1-3-7-8-10-11-12;A\x00\x0cprinter-info\x00\x14EPSON XP-6000 Series"\x00\x19printer-is-accepting-jobs\x00\x01\x01A\x00\x10printer-location\x00\x00A\x00\x16printer-make-and-model\x00\x14EPSON XP-6000 SeriesE\x00\x11printer-more-info\x00+http://192.168.1.92:80/PRESENTATION/BONJOURB\x00\x0cprinter-name\x00\tipp/print#\x00\rprinter-state\x00\x04\x00\x00\x00\x03D\x00\x15printer-state-reasons\x00\x04none!\x00\x0fprinter-up-time\x00\x04\x00\x0e-\x8cE\x00\x15printer-uri-supported\x00!ipps://192.168.1.92:631/ipp/printE\x00\x00\x00 ipp://192.168.1.92:631/ipp/print!\x00\x10queued-job-count\x00\x04\x00\x00\x00\x00D\x00\x16uri-security-supported\x00\x03tlsD\x00\x00\x00\x04noneD\x00\x1curi-authentication-supported\x00\x04noneD\x00\x00\x00\x04none\x12\x00\x14printer-geo-location\x00\x00D\x00\x18identify-actions-default\x00\x05flashD\x00\x1aidentify-actions-supported\x00\x05flash3\x00\x17jpeg-k-octets-supported\x00\x08\x00\x00\x00\x00\x00\x00@\x003\x00\x1ajpeg-x-dimension-supported\x00\x08\x00\x00\x00\x00\x00\x00:\x983\x00\x1ajpeg-y-dimension-supported\x00\x08\x00\x00\x00\x01\x00\x00:\x98D\x00\x16pdf-versions-supported\x00\x04noneD\x00\rurf-supported\x00\x03CP1D\x00\x00\x00\x05PQ4-5D\x00\x00\x00\x03OB9D\x00\x00\x00\x04OFU0D\x00\x00\x00\x05RS360D\x00\x00\x00\x06SRGB24D\x00\x00\x00\x02W8D\x00\x00\x00\x03DM3D\x00\x00\x00\x07IS1-7-6D\x00\x00\x00\x04V1.4D\x00\x00\x00\x12MT1-3-7-8-10-11-12D\x00!job-creation-attributes-supported\x00\x06copiesD\x00\x00\x00\nfinishingsD\x00\x00\x00\x16ipp-attribute-fidelityD\x00\x00\x00\x08job-nameD\x00\x00\x00\x05mediaD\x00\x00\x00\tmedia-colD\x00\x00\x00\x15orientation-requestedD\x00\x00\x00\noutput-binD\x00\x00\x00\rprint-qualityD\x00\x00\x00\x12printer-resolutionD\x00\x00\x00\x05sidesD\x00\x00\x00\x10print-color-modeD\x00\x00\x00\x16print-content-optimizeD\x00\x00\x00\rprint-scalingD\x00\x00\x00\x18job-mandatory-attributesB\x00\x0cmarker-names\x00\x0fPhoto Black inkB\x00\x00\x00\x08Cyan inkB\x00\x00\x00\x0bMagenta inkB\x00\x00\x00\nYellow inkB\x00\x00\x00\tBlack inkB\x00\rmarker-colors\x00\x07#000000B\x00\x00\x00\x07#00FFFFB\x00\x00\x00\x07#FF00FFB\x00\x00\x00\x07#FFFF00B\x00\x00\x00\x07#000000D\x00\x0cmarker-types\x00\rink-cartridgeD\x00\x00\x00\rink-cartridgeD\x00\x00\x00\rink-cartridgeD\x00\x00\x00\rink-cartridgeD\x00\x00\x00\rink-cartridge!\x00\x11marker-low-levels\x00\x04\x00\x00\x00\x0f!\x00\x00\x00\x04\x00\x00\x00\x0f!\x00\x00\x00\x04\x00\x00\x00\x0f!\x00\x00\x00\x04\x00\x00\x00\x0f!\x00\x00\x00\x04\x00\x00\x00\x0f!\x00\x12marker-high-levels\x00\x04\x00\x00\x00d!\x00\x00\x00\x04\x00\x00\x00d!\x00\x00\x00\x04\x00\x00\x00d!\x00\x00\x00\x04\x00\x00\x00d!\x00\x00\x00\x04\x00\x00\x00d!\x00\rmarker-levels\x00\x04\x00\x00\x00b!\x00\x00\x00\x04\x00\x00\x00[!\x00\x00\x00\x04\x00\x00\x00I!\x00\x00\x00\x04\x00\x00\x00_!\x00\x00\x00\x04\x00\x00\x00:E\x00\rprinter-icons\x00>https://192.168.1.92:443/PRESENTATION/AIRPRINT/PRINTER_128.PNGE\x00\x00\x00>https://192.168.1.92:443/PRESENTATION/AIRPRINT/PRINTER_512.PNG#\x00)landscape-orientation-requested-preferred\x00\x04\x00\x00\x00\x05E\x00\x0cprinter-uuid\x00-urn:uuid:cfe92100-67c4-11d4-a45f-f8d027761251B\x00\x13printer-dns-sd-name\x00\x14EPSON XP-6000 SeriesE\x00\x17printer-supply-info-uri\x009http://192.168.1.92:80/PRESENTATION/HTML/TOP/PRTINFO.HTML"\x00 multiple-document-jobs-supported\x00\x01\x00!\x00\x1bmultiple-operation-time-out\x00\x04\x00\x00\x00xD\x00\x16ipp-features-supported\x00\x0ewfds-print-1.0D\x00\x00\x00\x0cairprint-1.7D\x00\x0cprinter-kind\x00\x08documentD\x00\x00\x00\x08envelopeD\x00\x00\x00\x05photoD\x00\x00\x00\x04discD\x00"pwg-raster-document-type-supported\x00\x07sgray_8D\x00\x00\x00\x06srgb_82\x00(pwg-raster-document-resolution-supported\x00\t\x00\x00\x01h\x00\x00\x01h\x03D\x00\x1epwg-raster-document-sheet-back\x00\x07rotatedA\x00\x10mopria-certified\x00\x14mopria-certified 1.3B\x00\x15printer-firmware-name\x00\x08FirmwareA\x00\x1fprinter-firmware-string-version\x00\x0c20.44.NU11JA0\x00\x18printer-firmware-version\x00 000020440000JA1100000000000000000\x00\x12printer-input-tray\x00{type=other;dimunit=micrometers;mediafeed=279400;mediaxfeed=215900;maxcapacity=-2;level=-2;status=0;name=Sheet feeder bin 1;0\x00\x00\x00\x93type=sheetFeedAutoNonRemovableTray;dimunit=micrometers;mediafeed=279400;mediaxfeed=215900;maxcapacity=-2;level=-2;status=0;name=Sheet feeder bin 1;0\x00\x00\x00\x93type=sheetFeedAutoNonRemovableTray;dimunit=micrometers;mediafeed=152400;mediaxfeed=101600;maxcapacity=-2;level=-2;status=0;name=Sheet feeder bin 2;0\x00\x00\x00mtype=other;dimunit=micrometers;mediafeed=120000;mediaxfeed=120000;maxcapacity=-2;level=-2;status=5;name=Disc;0\x00\x13printer-output-tray\x00ytype=unRemovableBin;maxcapacity=50;remaining=-3;status=0;name=Face-up Tray;stackingorder=lastToFirst;pagedelivery=faceUp;D\x00\x14which-jobs-supported\x00\tcompletedD\x00\x00\x00\rnot-completedI\x00\x19document-format-preferred\x00\timage/urfD\x00"multiple-operation-time-out-action\x00\tabort-jobD\x00 printer-get-attributes-supported\x00\x0fdocument-formatD\x00"document-format-varying-attributes\x00\x06copiesD\x00\x00\x00\x05sidesA\x00\x14printer-organization\x00\x00A\x00\x1bprinter-organizational-unit\x00\x00H\x00#printer-strings-languages-supported\x00\x02enH\x00\x00\x00\x05es-mxH\x00\x00\x00\x02ptH\x00\x00\x00\x02frE\x00\x13printer-strings-uri\x00,http://192.168.1.92:80/LANGUAGES/IPP?LANG=en1\x00\x14printer-current-time\x00\x0b\x07\xe4\x03\n\x16\x17\x17\x00+\x00\x00\x13\x00\x1fprinter-config-change-date-time\x00\x00!\x00\x1aprinter-config-change-time\x00\x04\x00\x00\x00\x191\x00\x1eprinter-state-change-date-time\x00\x0b\x07\xe4\x03\x05\x13*$\x00+\x00\x00!\x00\x19printer-state-change-time\x00\x04\x00\x07p\\D\x00\x17jpeg-features-supported\x00\x04none\x03'  # noqa

RESPONSE_GET_JOBS_FULL = b"\x02\x00\x00\x00\x00\x01O\xac\x01G\x00\x12attributes-charset\x00\x05utf-8H\x00\x1battributes-natural-language\x00\x02en\x03"  # noqa


class FakeResolver:
    """Provides a fake resolver for local testing of external resources."""

    _LOCAL_HOST = {0: "127.0.0.1", socket.AF_INET: "127.0.0.1", socket.AF_INET6: "::1"}

    def __init__(self):
        """Resolve fakes -- host/port -> port dict."""
        self._servers = {}

    def add(self, host: str, port: int, target_port: int):
        """Add host/port to resolver."""
        self._servers[host, port] = target_port

    async def resolve(self, host, port=0, family=socket.AF_INET):
        """Resolve the fake port."""
        try:
            fake_port = self._servers[host, port]
        except KeyError:
            raise OSError("No test server known for %s" % host)
        return [
            {
                "hostname": host,
                "host": self._LOCAL_HOST[family],
                "port": fake_port,
                "family": family,
                "proto": 0,
                "flags": socket.AI_NUMERICHOST,
            }
        ]


class CaseControlledTestServer(RawTestServer):
    """Provides a test web server that can be controlled from test cases."""

    def __init__(self, **kwargs):
        """Initialize the server."""
        super().__init__(self._handle_request, **kwargs)
        self._requests = asyncio.Queue()
        self._responses = {}  # {id(request): Future}

    async def close(self):
        """Cancel all pending requests before closing."""
        for future in self._responses.values():
            future.cancel()

        await super().close()

    async def _handle_request(self, request):
        """Push request to test case and wait until it provides a response."""
        self._responses[id(request)] = response = asyncio.Future()
        self._requests.put_nowait(request)

        try:
            # wait until test case provides a response
            return await response
        finally:
            del self._responses[id(request)]

    async def receive_request(self):
        """Wait until test server receives a request."""
        return await self._requests.get()

    def send_response(self, request, *args, **kwargs):
        """Send web response from test case to client code."""
        response = web.Response(*args, **kwargs)
        self._responses[id(request)].set_result(response)
